<!doctype html><html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta><title>微信小程序 WebView First 开发方案实践 - 毛呆&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="毛呆&#039;s Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="毛呆&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="WebView First，是指优先使用 WebView 进行开发，在 WebView 无法满足需求时，再使用原生（微信小程序原生，后续提到原生皆为此意）实现。"><meta property="og:type" content="blog"><meta property="og:title" content="微信小程序 WebView First 开发方案实践"><meta property="og:url" content="https://blog.maodai.site/2022/08/17/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-WebView-First-%E5%BC%80%E5%8F%91%E6%96%B9%E6%A1%88%E5%AE%9E%E8%B7%B5/"><meta property="og:site_name" content="毛呆&#039;s Blog"><meta property="og:description" content="WebView First，是指优先使用 WebView 进行开发，在 WebView 无法满足需求时，再使用原生（微信小程序原生，后续提到原生皆为此意）实现。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://blog.maodai.site/2022/08/17/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-WebView-First-%E5%BC%80%E5%8F%91%E6%96%B9%E6%A1%88%E5%AE%9E%E8%B7%B5/weapp-page-structure.svg"><meta property="article:published_time" content="2022-08-17T21:21:45.000Z"><meta property="article:modified_time" content="2023-07-18T01:44:51.034Z"><meta property="article:author" content="aweikalee"><meta property="article:tag" content="微信小程序"><meta property="article:tag" content="WebView"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/2022/08/17/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-WebView-First-%E5%BC%80%E5%8F%91%E6%96%B9%E6%A1%88%E5%AE%9E%E8%B7%B5/weapp-page-structure.svg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.maodai.site/2022/08/17/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-WebView-First-%E5%BC%80%E5%8F%91%E6%96%B9%E6%A1%88%E5%AE%9E%E8%B7%B5/"},"headline":"微信小程序 WebView First 开发方案实践","image":[],"datePublished":"2022-08-17T21:21:45.000Z","dateModified":"2023-07-18T01:44:51.034Z","author":{"@type":"Person","name":"aweikalee"},"description":"WebView First，是指优先使用 WebView 进行开发，在 WebView 无法满足需求时，再使用原生（微信小程序原生，后续提到原生皆为此意）实现。"}</script><link rel="canonical" href="https://blog.maodai.site/2022/08/17/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-WebView-First-%E5%BC%80%E5%8F%91%E6%96%B9%E6%A1%88%E5%AE%9E%E8%B7%B5/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?603c9db999df88a1cab3437e7ad365e0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/cookieconsent/3.1.1/cookieconsent.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="毛呆&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">分类</a><a class="navbar-item" href="/categories">归档</a><a class="navbar-item" href="/tags">标签</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time datetime="2022-08-17T21:21:45.000Z" title="8/17/2022, 9:21:45 PM">2022-08-17</time>发表</span><span class="level-item"><a class="link-muted" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a><span> / </span><a class="link-muted" href="/categories/%E5%89%8D%E7%AB%AF/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/">微信小程序</a><span> / </span><a class="link-muted" href="/categories/%E5%89%8D%E7%AB%AF/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/">开发记录</a></span><span class="level-item">19 分钟读完 (大约2827个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">微信小程序 WebView First 开发方案实践</h1><div class="content"><html><head></head><body><p><strong>WebView First</strong>，是指优先使用 WebView 进行开发，在 WebView 无法满足需求时，再使用原生（微信小程序原生，<em>后续提到原生皆为此意</em>）实现。</p><span id="more"></span><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>首先声明立场，我是一个微信小程序黑。作为一个 Web 开发者，内心是抵制小程序的，但奈何生活所迫，该写还是得写。好在还有一条<strong>开发的是 Web，但入口是小程序</strong>的道路可以走。</p><p>尽管在小程序中 WebView 的应用非常普遍，但还是以原生为主的方式进行开发。缺乏以 WebView 为主的案例。</p><p>本文是我的 <strong>WebView First</strong> 实践的记录，希望能给想尝试 <strong>WebView First</strong> 的各位，提供帮助和底气。</p><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><h3 id="主要原则"><a href="#主要原则" class="headerlink" title="主要原则"></a>主要原则</h3><p>以 WebView 为主构建小程序，优先通过 <code>JS-SDK</code> 调用微信能力（同公众号），其次再考虑跳转到原生页面调小程序的接口。</p><p>尽可能让用户长时间停留在 WebView ，避免 WebView 与原生页面之间切换。</p><p>原生页面与 WebView 之间通过 URL 进行通信。</p><h3 id="好处"><a href="#好处" class="headerlink" title="好处"></a>好处</h3><ol><li><strong>提升开发体验、提高开发效率</strong></li><li>降低小程序审核频率</li><li>大部分场景下有更好的性能</li><li>更多的 npm 包可以使用</li><li>更多的解决方案可以参考</li><li>更容易地迁移到其他端</li></ol><h3 id="那代价是什么？"><a href="#那代价是什么？" class="headerlink" title="那代价是什么？"></a>那代价是什么？</h3><ol><li>WebView 页面首次渲染较慢（首次渲染指重启小程序，并非第一次访问小程序）【可用 Web 白屏/首屏问题的优化方式进行优化】</li><li>原生页面与 WebView 页面之间，切换成本高【和产品商量，减少这种场景出现】</li><li>页面栈管理受限</li><li>使用小程序的能力受限【小部分可用 <code>JS-SDK</code> 代替，其余需要跳转到原生页面实现】</li><li><code>Android</code> 下持久储存（如 <code>localStorage</code>、<code>cookie</code>）不符合预期【详细说明见下文】</li><li>无法使用现成且丰富的小程序组件【但你有更多组件库可以选择】</li><li>部分组件实现的性能不如小程序提供的原生组件</li><li>无法使用自定义导航栏【可以跳转到原生页面实现，但不推荐使用的原因同第2点】</li><li>页面切换动画效果不一致（WebView 内切换、WebView 与原生之间切换）</li><li>原生视频/直播的小窗口（画中画）在安卓中不能带到 WebView【没有很好的解决方案，避免使用画中画时前往 WebView 吧】</li></ol><h3 id="与原生-First-的差异"><a href="#与原生-First-的差异" class="headerlink" title="与原生 First 的差异"></a>与原生 First 的差异</h3><blockquote><p>原生 First 即优先使用原生，部分页面嵌入 WebView。</p></blockquote><ul><li><strong>WebView First</strong> 大部分操作在 WebView 中进行，大幅度降低了 WebView 页面与原生页面的切换（切换和通信成本较高）</li><li><strong>WebView First</strong> 结构更为简单，基本不需要考虑小程序</li><li>持久储存，<strong>原生 First</strong> 主要存在小程序，<strong>WebView First</strong> 存在 WebView。</li></ul><h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><blockquote><p>本文将以 <code>Vue</code> 全家桶作为 Web 侧的技术栈进行说明。</p></blockquote><h3 id="小程序页面结构"><a href="#小程序页面结构" class="headerlink" title="小程序页面结构"></a>小程序页面结构</h3><p><img src="/2022/08/17/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-WebView-First-%E5%BC%80%E5%8F%91%E6%96%B9%E6%A1%88%E5%AE%9E%E8%B7%B5/weapp-page-structure.svg" alt="小程序页面结构"></p><p>为了让左上角的出现<strong>返回</strong>，我们需要一个入口页面（没有内容的），当入口页面 <code>onShow</code> 时，则 <code>navigateTo</code> 到 WebView 页面。</p><p>对于其他原生页，建议是想象成弹窗处理，最后都要退回到 WebView 页面。（务必和产品说好，避免出现 WebView 与原生之间的频繁跳转）</p><h3 id="环境区分"><a href="#环境区分" class="headerlink" title="环境区分"></a>环境区分</h3><p>从微信 <code>7.0.0</code> 开始，可以通过判断 <code>userAgent</code> 中包含 <code>miniProgram</code> 字样来判断小程序 WebView 环境。</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> IS_WEAPP = navigator.userAgent.toLowerCase().includes(<span class="string">'miniprogram'</span>)</span><br></pre></td></tr></tbody></table></figure><h3 id="原生与-WebView-的通信"><a href="#原生与-WebView-的通信" class="headerlink" title="原生与 WebView 的通信"></a>原生与 WebView 的通信</h3><p>虽然小程序提供了 <code>message</code> 事件，允许 WebView 向小程序发送消息，但是由于触发条件相当苛刻，很难满足需求。</p><p>再由于需要通信的场景都是 WebView 与原生之间切换，所以采用了通过跳转地址进行传参。</p><p>具体实现见下一节。</p><p>另外，需要注意地址的长度限制。</p><h3 id="路由跳转管理"><a href="#路由跳转管理" class="headerlink" title="路由跳转管理"></a>路由跳转管理</h3><p>路由跳转大致分为三类：</p><ol><li>WebView 到 WebView</li><li>原生到原生</li><li>WebView 到原生</li><li>原生到 WebView</li></ol><p>对应处理方式：</p><ol><li>不需要任何处理</li><li>不需要任何处理</li><li>使用 <code>JS-SDK</code> 进行跳转，使用 <code>navigateTo</code> 将原生页推入页面栈中</li><li>尽可能使用后退的形式退回，根据情况，刷新 WebView 的内容。</li></ol><p>3、4两种情况尽可能避免，因为 WebView 初始化略慢，这会大大降低用户体验、增加维护的难度。</p><p>然后我这边引入了第三方库 <code>qs</code> 用来对 query 进行解析和字符串化。</p><h4 id="WebView-跳转到原生"><a href="#WebView-跳转到原生" class="headerlink" title="WebView 跳转到原生"></a>WebView 跳转到原生</h4><p>我选择了路由配置和<code>导航守卫</code>进行路由管理。</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router = createRouter({</span><br><span class="line">  routes: [</span><br><span class="line">    {</span><br><span class="line">      path: <span class="string">'/payment'</span>,</span><br><span class="line">      name: <span class="string">'Payment'</span></span><br><span class="line">      component: { <span class="comment">/* ... */</span> }, <span class="comment">// 若没有对应的页面，可设置为 404 页</span></span><br><span class="line">      meta: {</span><br><span class="line">        weapp: <span class="string">'/pages/payment'</span>, <span class="comment">// 小程序中对应页面的路径</span></span><br><span class="line">      },</span><br><span class="line">    },</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ...其他路由 */</span></span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* ...其他配置项 */</span></span><br><span class="line">})</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.beforeEach(<span class="function">(<span class="params">to</span>) =&gt;</span> {</span><br><span class="line">  <span class="comment">/* 判断小程序环境 */</span></span><br><span class="line">  <span class="keyword">if</span> (!IS_WEAPP) <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 判断 meta.weapp 是否存在 */</span></span><br><span class="line">  <span class="keyword">if</span> (!to.meta?.weapp) <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// qs.stringify 将对象拼接成 key=value 形式的字符串</span></span><br><span class="line">  <span class="keyword">const</span> query = qs.stringify({</span><br><span class="line">    <span class="comment">// 必要的数据统一添加到 query 中，如 token</span></span><br><span class="line">    token: <span class="string">'token'</span>,</span><br><span class="line">    ...to.query</span><br><span class="line">  })</span><br><span class="line">  <span class="keyword">const</span> url = <span class="string">`<span class="subst">${to.meta.weapp}</span>?<span class="subst">${query}</span>`</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 调用 JS-SDK 跳转 */</span></span><br><span class="line">  wx.miniProgram.navigateTo({ url })</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><h4 id="原生跳转到-WebView"><a href="#原生跳转到-WebView" class="headerlink" title="原生跳转到 WebView"></a>原生跳转到 WebView</h4><p>在小程序中设置一个全局变量作为 <code>web-view</code> 的地址，当原生的 WebView 页面 <code>onShow</code> 时，更新 <code>web-view</code> 组件的 <code>src</code> 的值。</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webview-src.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 这个就是全局变量，也可以放到 getApp().globalData 中 */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> state = {</span><br><span class="line">  src: <span class="string">''</span>,</span><br><span class="line">  query: {}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">setSrc</span>(<span class="params">options = {}</span>) </span>{</span><br><span class="line">  state.query = {</span><br><span class="line">    is_weapp: <span class="string">'true'</span>,</span><br><span class="line">    ...options.query,</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">const</span> _query = qs.stringify(query)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// __WEBVIEW_URL__ 是 WebView 的访问地址</span></span><br><span class="line">  state.src = <span class="string">`<span class="subst">${__WEBVIEW_URL__}</span><span class="subst">${options.path}</span>?<span class="subst">${_query}</span>`</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">navigateBack</span>(<span class="params">options, navigateOptions = {}</span>) </span>{</span><br><span class="line">  setSrc(options)</span><br><span class="line">  wx.navigateBack(navigateOptions)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">navigateTo</span>(<span class="params">options, navigateOptions = {}</span>) </span>{</span><br><span class="line">  setSrc(options)</span><br><span class="line">  wx.navigateTo({</span><br><span class="line">    ...navigateOptions,</span><br><span class="line">    url: <span class="string">'/pages/webview/index'</span> <span class="comment">// WebView 页面路径</span></span><br><span class="line">  })</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">navigateTo</span>(<span class="params">options, navigateOptions = {}</span>) </span>{</span><br><span class="line">  setSrc(options)</span><br><span class="line">  wx.navigateTo({</span><br><span class="line">    ...navigateOptions,</span><br><span class="line">    url: <span class="string">'/pages/webview/index'</span> <span class="comment">// WebView 页面路径</span></span><br><span class="line">  })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebView 页面的 js 文件</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> webview  <span class="keyword">from</span> <span class="string">'./webview-src'</span></span><br><span class="line"></span><br><span class="line">Page({</span><br><span class="line">  data: {</span><br><span class="line">    src: <span class="string">''</span></span><br><span class="line">  },</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">onShow</span>(<span class="params"></span>)</span> {</span><br><span class="line">    <span class="built_in">this</span>.setData({</span><br><span class="line">      src: webview.state.src</span><br><span class="line">    })</span><br><span class="line">  }</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><h3 id="持久储存"><a href="#持久储存" class="headerlink" title="持久储存"></a>持久储存</h3><p>正常来讲，直接使用 <code>localStorage</code> 或是 <code>cookie</code> 作为持久储存就行了。但是安卓中小程序是多进程，不同进程的 WebView 的持久储存数据是隔离的。当你把小程序的进程关了，再打开时可能会拿到和上一次完全不一样的数据。</p><p>那么，我们就需要将 WebView 的持久储存数据存到 WebView 之外。可选的只有存到小程序的 <code>storage</code> 和存到服务器。</p><p>存小程序的 <code>storage</code> 中，则必须经过 <code>message</code> 事件。存在两个问题：一、<code>message</code> 事件无法稳定触发；二、取回数据只能通过地址传数据，长度存在限制。故，这个方案被放弃了。</p><p>存到服务器，首先需要解决的是区分设备，其次再解决安全性的问题。</p><h4 id="区分设备"><a href="#区分设备" class="headerlink" title="区分设备"></a>区分设备</h4><p>我采用的是由服务器生成设备 ID，存在小程序中，通过地址将设备 ID 传给 WebView。</p><h4 id="安全性"><a href="#安全性" class="headerlink" title="安全性"></a>安全性</h4><p>若设备 ID 泄露了，会被轻松获取到全部的持久储存数据。我们可以提高盗用的门槛，增加了一次性签名，以设备 ID 和时间作为签名数据，通过公私钥的形式创建签名。而签名的创建在小程序内进行（WebView 中也行，但会降低安全性），签名也通过地址传给 WebView。</p><p>另外还可以定期更换设备 ID。</p><p>上传数据也可以适当增加门槛，比如拉取时同样的签名机制，比如拉取时给与上传数据用的 token（下次拉取时失效），等等。</p><h4 id="其他说明"><a href="#其他说明" class="headerlink" title="其他说明"></a>其他说明</h4><p>由于持久储存数据丢失，仅仅只是在小程序进程被杀的情况。所以只需要在小程序首次启动进入 WebView 的时候需要从服务器拉数据。在路由参数中增加首次访问的标识。</p><h4 id="Web-侧拉取数据的处理"><a href="#Web-侧拉取数据的处理" class="headerlink" title="Web 侧拉取数据的处理"></a>Web 侧拉取数据的处理</h4><p>我用了比较粗暴的方案，在创建 Vue 实例前请求数据，将数据更新到持久储存之后直接刷新页面，同时移除地址参数中的设备 ID 和签名。</p><p>如果你的项目中，读取持久储存数据都发生在 Vue 实例创建之后，那么不必通过刷新重新读取数据。</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">pullStorage</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="comment">/* 仅小程序环境且是安卓系统 需要拉取数据 */</span></span><br><span class="line">  <span class="keyword">if</span> (!(IS_WEAPP &amp;&amp; IS_ANDROID)) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> url = <span class="keyword">new</span> URL(location.href)</span><br><span class="line">  <span class="keyword">const</span> deviceId = url.searchParams.get(<span class="string">'device_id'</span>) <span class="comment">// 设备 ID</span></span><br><span class="line">  <span class="keyword">const</span> deviceSign = url.searchParams.get(<span class="string">'device_sign'</span>) <span class="comment">// 拉取数据用的签名</span></span><br><span class="line">  <span class="keyword">if</span> (!(deviceId &amp;&amp; deviceSign)) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="comment">/* 发起请求 */</span></span><br><span class="line">    <span class="keyword">const</span> fetchUrl = <span class="string">`/pull-storage?id=<span class="subst">${deviceId}</span>&amp;sign=<span class="subst">${deviceSign}</span>`</span></span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> fetch(fetchUrl).then(<span class="function">(<span class="params">res</span>) =&gt;</span> res.json())</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* storageKeys 是项目中所用到的 storage 的键名 */</span></span><br><span class="line">    <span class="comment">/* storage 是 localStorage 的封装 */</span></span><br><span class="line">    <span class="comment">/* 将拉取到的数据存到 localStorage 中 */</span></span><br><span class="line">    storageKeys.forEach(<span class="function"><span class="params">key</span> =&gt;</span> {</span><br><span class="line">      <span class="keyword">const</span> value = data?.[key]</span><br><span class="line">      storage.setItem(key, value)</span><br><span class="line">    })</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 保存设备 ID，用于上传数据 */</span></span><br><span class="line">    storage.setItem(<span class="string">'deviceId'</span>, deviceId)</span><br><span class="line">  } <span class="keyword">catch</span> (err) {</span><br><span class="line">    <span class="built_in">console</span>.error(err) <span class="comment">// 请求失败不做处理</span></span><br><span class="line">  } <span class="keyword">finally</span> {</span><br><span class="line">    url.searchParams.delete(<span class="string">'device_id'</span>)</span><br><span class="line">    url.searchParams.delete(<span class="string">'device_sign'</span>)</span><br><span class="line">    location.replace(url.toString()) <span class="comment">// 刷新页面</span></span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">() =&gt;</span> {}) <span class="comment">// 阻止渲染，等待页面刷新</span></span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">const</span> app = createApp(App)</span><br><span class="line">  <span class="comment">/* ... */</span></span><br><span class="line">  app.mount(<span class="string">'#app'</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">pullStorage().finally(init)</span><br></pre></td></tr></tbody></table></figure><h3 id="JS-SDK"><a href="#JS-SDK" class="headerlink" title="JS-SDK"></a>JS-SDK</h3><p>能用 <code>JS-SDK</code> 解决的，就不要跳到原生页面。</p><p>不过要注意并不是所有 <code>JS-SDK</code> 的接口都能在小程序中使用，具体请查询 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/component/web-view.html#%E7%9B%B8%E5%85%B3%E6%8E%A5%E5%8F%A3-2">《web-view | 微信开放文档》</a>。</p><p>除了小程序特有的路由相关的接口，其他接口均需要先进行<strong>权限验证配置</strong>。此处有两个坑。</p><h4 id="相关配置"><a href="#相关配置" class="headerlink" title="相关配置"></a>相关配置</h4><p><code>JS-SDK</code> 所有的参数和配置，均为公众号，而非小程序。<code>appId</code> 使用公众号的；安全域名配置在公众号下。</p><h4 id="wx-config-签名参数-url"><a href="#wx-config-签名参数-url" class="headerlink" title="wx.config 签名参数 url"></a>wx.config 签名参数 url</h4><p>不同设备、不同版本微信 url 的取值不一致。</p><ol><li><code>iOS</code> 首次访问时的地址</li><li><code>Android</code> + 旧版本微信（推测 8.x 之前，没有明确的版本分界线），当前地址</li><li><code>Android</code> + 新版本微信，两者皆可</li></ol><p>另外注意不要带 <code>hash</code>。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>牺牲了特定场景的用户体验和产品设计自由度，换来开发体验、开发效率以及大部分场景的用户体验。</p><p>但是，如果对小程序原生组件或能力依赖比较严重（且不能单独分离出来一个页面），或是有不能接受的代价，不建议尝试该方案。</p><p>最后，愿世间没有小程序。</p></body></html></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/">微信小程序</a><a class="link-muted mr-2" rel="tag" href="/tags/WebView/">WebView</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2022/09/03/Vue2-%E7%BB%84%E4%BB%B6%E4%BA%8C%E6%AC%A1%E5%B0%81%E8%A3%85-Element-UI-Table/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Vue2 组件二次封装 Element UI Table</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/12/20/Vue3-%E7%BB%84%E4%BB%B6%E4%BA%8C%E6%AC%A1%E5%B0%81%E8%A3%85-Element-Plus-Table/"><span class="level-item">Vue3 组件二次封装 Element Plus Table</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#前言"><span class="level-left"><span class="level-item">1</span><span class="level-item">前言</span></span></a></li><li><a class="level is-mobile" href="#介绍"><span class="level-left"><span class="level-item">2</span><span class="level-item">介绍</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#主要原则"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">主要原则</span></span></a></li><li><a class="level is-mobile" href="#好处"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">好处</span></span></a></li><li><a class="level is-mobile" href="#那代价是什么？"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">那代价是什么？</span></span></a></li><li><a class="level is-mobile" href="#与原生-First-的差异"><span class="level-left"><span class="level-item">2.4</span><span class="level-item">与原生 First 的差异</span></span></a></li></ul></li><li><a class="level is-mobile" href="#实践"><span class="level-left"><span class="level-item">3</span><span class="level-item">实践</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#小程序页面结构"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">小程序页面结构</span></span></a></li><li><a class="level is-mobile" href="#环境区分"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">环境区分</span></span></a></li><li><a class="level is-mobile" href="#原生与-WebView-的通信"><span class="level-left"><span class="level-item">3.3</span><span class="level-item">原生与 WebView 的通信</span></span></a></li><li><a class="level is-mobile" href="#路由跳转管理"><span class="level-left"><span class="level-item">3.4</span><span class="level-item">路由跳转管理</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#WebView-跳转到原生"><span class="level-left"><span class="level-item">3.4.1</span><span class="level-item">WebView 跳转到原生</span></span></a></li><li><a class="level is-mobile" href="#原生跳转到-WebView"><span class="level-left"><span class="level-item">3.4.2</span><span class="level-item">原生跳转到 WebView</span></span></a></li></ul></li><li><a class="level is-mobile" href="#持久储存"><span class="level-left"><span class="level-item">3.5</span><span class="level-item">持久储存</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#区分设备"><span class="level-left"><span class="level-item">3.5.1</span><span class="level-item">区分设备</span></span></a></li><li><a class="level is-mobile" href="#安全性"><span class="level-left"><span class="level-item">3.5.2</span><span class="level-item">安全性</span></span></a></li><li><a class="level is-mobile" href="#其他说明"><span class="level-left"><span class="level-item">3.5.3</span><span class="level-item">其他说明</span></span></a></li><li><a class="level is-mobile" href="#Web-侧拉取数据的处理"><span class="level-left"><span class="level-item">3.5.4</span><span class="level-item">Web 侧拉取数据的处理</span></span></a></li></ul></li><li><a class="level is-mobile" href="#JS-SDK"><span class="level-left"><span class="level-item">3.6</span><span class="level-item">JS-SDK</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#相关配置"><span class="level-left"><span class="level-item">3.6.1</span><span class="level-item">相关配置</span></span></a></li><li><a class="level is-mobile" href="#wx-config-签名参数-url"><span class="level-left"><span class="level-item">3.6.2</span><span class="level-item">wx.config 签名参数 url</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#总结"><span class="level-left"><span class="level-item">4</span><span class="level-item">总结</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer="defer"></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="毛呆&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2023 aweikalee</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="GitHub" href="https://github.com/aweikalee"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer="defer"></script><script>moment.locale("zh-CN")</script><script>var IcarusThemeSettings={article:{highlight:{clipboard:!0,fold:"unfolded"}}}</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer="defer"></script><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/cookieconsent/3.1.1/cookieconsent.min.js" defer="defer"></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer="defer"></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer="defer"></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" defer="defer"></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer="defer"></script><script src="/js/navbar.js"></script><script src="https://cdnjs.loli.net/ajax/libs/mermaid/8.9.3/mermaid.min.js"></script><script>window.mermaid&&mermaid.initialize()</script><style>.mermaid > svg { height: auto; }</style><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer="defer"></script><script>document.addEventListener("DOMContentLoaded",function(){loadInsight({contentUrl:"/content.json"},{hint:"想要查找什么...",untitled:"(无标题)",posts:"文章",pages:"页面",categories:"分类",tags:"标签"})})</script></body></html>